Инструкция по установке модуля
------------------------------

__1. Для установки платежного модуля BeGateway необходимо произвести следующие действия__

Скачайте архив модуля. Загрузите архив в папку core/packages/ вашего сайта.

В панели управления перейдите "Система" - "Управление пакетами" - "Добавить новый пакет" - "Искать пакеты локально" - "Дальше".

В таблице пакетов появится пакет "begateway". Нажмите кнопку "Установить".

Завершите установку.


__2. Необходимо проверить, что созданы 4 страницы__

1 - страница оплаты через Begateway ( "Оплатить заказ" ).

Поле "Содержимое ресурса" должно быть следующим:

       [[!begateway? action=`payment`]]

       Шаблон Начальный или пользовательский для вывода сообщений и текстовых страниц

2 - страница с сообщением об успешной оплате ( "Спасибо за заказ" ).

Поле "Содержимое ресурса" должно быть следующим:

       [[!begateway? action=`success`]]

       Шаблон Начальный или пользовательский для вывода сообщений и текстовых страниц

3 - страница с сообщением о неуспешной оплате ( "Ошибка оплаты" ).

Поле "Содержимое ресурса" должно быть следующим:

       [[!begateway? action=`fail`]]

       Шаблон Начальный или пользовательский для вывода сообщений и текстовых страниц

4 - страница для уведомлений об оплате ( "Begateway Notify" ).

Поле "Содержимое ресурса" должно быть следующим:

       [[!begateway? action=`notify`]]

       Шаблон Пустой (без шаблона)

Все эти ресурсы должны быть опубликованы и скрыты из меню.


__3. Измените параметры сниппета Begateway__

`shopId` - ID магазина в платежной системе

`shopSecretKey` - Секретный ключ магазина в платежной системе

`shopPublicKey` - Публичный ключ магазина в платежной системе

`paymentDomain` - Домен платежной страницы

`test` - Включить режим работы Тестовый (Да/Нет)

`currency` - Код валюта по-умолчанию (указывается код валюты вашей платежной системы)

`currencyMode` - Режим выставления счета на оплату (в валюте по-умолчанию или в валюте выбранной пользователем, смотрите раздел мультивалютность)

`redirectMode` - Режим перевода пользователя на страницу оплаты (сразу после нажатия на кнопку "Оформить заказ" или с выводом страницы инвойса и кнопкой "Оплатить")

`chunkOrderDetail` - Чанк для вывода Инвойса перед оплатой

`chunkOrderDetailRow` - Чанк строки товаров в инвойсе

`chunkOrderContactsRow` - Чанк вывода контактов покупателя в инвойсе

`chunkOrderTryAgainDetail` - Чанк для вывода инвойса если оплата не удалась (инвойс для страницы попробовать оплатить еще раз)

`chunkOrderSuccessPaid` - Чанк для вывода сообщения об успешной оплате и успешном заказе

`pagePayment` - Id ресурса "Оплатить заказ"

`pageSuccess` - Id ресурса "Спасибо за заказ"

`pageFailure` - Id ресурса "Ошибка оплаты"

`pageNotify` - Id ресурса "Begateway Notify"

`statusNew` - Id статуса "Новый заказ" (порядковый номер, обычно статус Новый стоит первым - 1)

`statusAccept` - Id статуса "Принят к оплате" (порядковый номер, обычно статус Приянт к оплате стоит вторым - 2)

`statusCancel` - Id статуса "Заказ отменен" (порядковый номер, обычно статус Отменен стоит пятым - 5)

`statusPaid` - Id статуса "Оплата получена" (порядковый номер, обычно статус Оплата получена стоит шестым - 6)

__4. Настроить методы оплаты Shopkeeper3__

В главном меню выберите «Пакеты» — «Управление заказами (SHK3)»

В правом верхнем углу нажмите кнопку = и выберите «настройки»

Выберите настройку «Методы оплаты»

Нажмите кнопку «Добавить» и заполните поля «Название» и «Значение».
Поле «Название» может быть произвольным — это текстовое представление типа оплаты в форме заказа, например “Оплата картой”.
Поле «Значение» обязательно должно содержать слово begateway без заглавных букв, именно это слово передается формой оплаты в параметре payment.

На странице формы оформления заказа в вызове сниппета FormIt в список используемых хуков необходимо добавить begateway перед redirect.

       [[!FormIt?
          &hooks=`spam,shk_fihook,email,FormItAutoResponder,begateway,redirect`
          &submitVar=`order`
          &emailTpl=`shopOrderReport`
          &fiarTpl=`shopOrderReport`
          &emailSubject=`В интернет-магазине "[[++site_name]]" сделан новый заказ`
          &fiarSubject=`Вы сделали заказ в интернет-магазине "[[++site_name]]"`
          &emailTo=`[[++emailsender]]`
          &fiarReplyTo=`[[++emailsender]]`
          &fiarToField=`email`
          &emailFrom=`[[++emailsender]]`
          &emailFromName=`[[++emailsender]]`
          &fiarFrom=`[[++emailsender]]`
          &redirectTo=`8`
          &validate=`fullname:required,address:required,email:email:required,phone:required,shk_delivery:required,payment:required`
          &errTpl=`<br /><span class="error">[[+error]]</span>`
       ]]

__5. Мультивалютность__

Должен быть включен плагин shk_multicurrency.

В настройках снипета begateway укажите код валюты по умолчанию для вашей платежной системы.

__ВАЖНО!__
В настройках валют она должна быть первая либо в настройках системы в разделе shopkeeper3 -> shk3.currency_default указан номер очередности валюты по умолчанию.

Выберите вариант выставления счетов клиенту (в валюте по умолчанию или в валюте пользователя).

Если в валюте по умолчанию:

Cледите за курсом валют в настройках shopkeeper3, иначе возможны сильные расхождения в указанной сумме у пользователя на экране и его  списании с карты.

Если в валюте пользователя:

__ВАЖНО!__
В настройках shopkeeper3 в списке валют название валюты указывайте в виде кода валюты
Например рубли указывать не руб. - а RUB, доллары сша не $ или доллары - а USD и так далее.


__Удачных платежей.__



ТЕСТИРОВАНИЕ
---------------------

Вы можете использовать следующие данные, чтобы настроить способ оплаты в тестовом режиме

* __Идентификационный номер магазина:__ 361
* __Секретный ключ магазина:__ b8647b68898b084b836474ed8d61ffe117c9a01168d867f24953b776ddcb134d
* __Публичный ключ магазина:__ MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArO7bNKtnJgCn0PJVn2X7QmhjGQ2GNNw412D+NMP4y3Qs69y6i5T/zJBQAHwGKLwAxyGmQ2mMpPZCk4pT9HSIHwHiUVtvdZ/78CX1IQJON/Xf22kMULhquwDZcy3Cp8P4PBBaQZVvm7v1FwaxswyLD6WTWjksRgSH/cAhQzgq6WC4jvfWuFtn9AchPf872zqRHjYfjgageX3uwo9vBRQyXaEZr9dFR+18rUDeeEzOEmEP+kp6/Pvt3ZlhPyYm/wt4/fkk9Miokg/yUPnk3MDU81oSuxAw8EHYjLfF59SWQpQObxMaJR68vVKH32Ombct2ZGyzM7L5Tz3+rkk7C4z9oQIDAQAB
* __Домен платежной страницы:__ checkout.begateway.com
* __Режим оплаты:__ Тестовый

Используйте следующие данные карты для успешного тестового платежа:

* Номер карты: 4200000000000000
* Имя на карте: JOHN DOE
* Месяц срока действия карты: 01/30
* CVC: 123

Используйте следующие данные карты для неуспешного тестового платежа:

* Номер карты: 4005550000000019
* Имя на карте: JOHN DOE
* Месяц срока действия карты: 01/30
* CVC: 123